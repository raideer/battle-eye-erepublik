// ==UserScript==
// @name        Battle Eye Live
// @namespace   battle-eye-live
// @author      Industrials / Raideer
// @homepage    https://github.com/raideer
// @description LIVE battlefield statistics
// @include     http*://www.erepublik.com/*/military/battlefield-new/*
// @version     1.0.2-a
// @require     https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.5/handlebars.min.js
// @run-at      document-idle
// ==/UserScript==

"use strict";function _possibleConstructorReturn(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var _get=function t(e,i,s){null===e&&(e=Function.prototype);var n=Object.getOwnPropertyDescriptor(e,i);if(void 0===n){var a=Object.getPrototypeOf(e);return null===a?void 0:t(a,i,s)}if("value"in n)return n.value;var r=n.get;if(void 0!==r)return r.call(s)},_createClass=function(){function t(t,e){for(var i=0;i<e.length;i++){var s=e[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(t,s.key,s)}}return function(e,i,s){return i&&t(e.prototype,i),s&&t(e,s),e}}(),DpsHandler=function(){function t(e){_classCallCheck(this,t),this.rememberDpsFor=e,this.hitHistory=new HitHistory(1e3*e),this.hitStreakSeconds=0,this.lastHit=0,this.dps=0}return _createClass(t,[{key:"addHit",value:function(t){this.lastHit=(new Date).getTime(),this.hitHistory.add(t)}},{key:"updateDps",value:function(t){var e=this.hitHistory.getTotal();this.hitStreakSeconds<this.rememberDpsFor&&this.hitStreakSeconds++,this.dps=Math.round(e/this.hitStreakSeconds),t.time-this.lastHit>=1e4&&(this.hitHistory.clear(),this.hitStreakSeconds=0)}}]),t}(),Divisions=function(){function t(){_classCallCheck(this,t),this.div1=new DivisionStats(1),this.div2=new DivisionStats(2),this.div3=new DivisionStats(3),this.div4=new DivisionStats(4)}return _createClass(t,[{key:"handle",value:function(t){this.div1.handle(t),this.div2.handle(t),this.div3.handle(t),this.div4.handle(t)}},{key:"updateDps",value:function(t){this.div1.updateDps(t),this.div2.updateDps(t),this.div3.updateDps(t),this.div4.updateDps(t)}},{key:"toObject",value:function(){return{div1:this.div1.toObject(),div2:this.div2.toObject(),div3:this.div3.toObject(),div4:this.div4.toObject()}}}]),t}(),DivisionStats=function(t){function e(t){_classCallCheck(this,e);var i=_possibleConstructorReturn(this,Object.getPrototypeOf(e).call(this,10));return i.division=t,i.hits=0,i.damage=0,i}return _inherits(e,t),_createClass(e,[{key:"handle",value:function(t){t.division==this.division&&(this.addHit(t.msg.damage),this.hits++,this.damage+=t.msg.damage)}},{key:"toObject",value:function(){return{damage:this.damage.toLocaleString(),id:this.id,dps:this.dps.toLocaleString(),avgHit:Math.round(this.damage/this.hits).toLocaleString()}}}]),e}(DpsHandler),EventHandler=function(){function t(){_classCallCheck(this,t),this.events={}}return _createClass(t,[{key:"emit",value:function(t,e){this.events[t]&&this.events[t].forEach(function(t){return t(e)})}},{key:"on",value:function(t,e){this.events[t]=this.events[t]||[],this.events[t].push(e)}},{key:"off",value:function(t,e){if(this.events[t])for(var i in this.events[t]){var s=this.events[t][i];s==e&&this.events[t].splice(i,1)}}}]),t}(),HitHistory=function(){function t(){var e=arguments.length<=0||void 0===arguments[0]?3e4:arguments[0];_classCallCheck(this,t),this.rememberFor=e,this.history={}}return _createClass(t,[{key:"add",value:function(t){var e=(new Date).getTime();this.history[e]=t,this.trimOld(e)}},{key:"trimOld",value:function(){var t=arguments.length<=0||void 0===arguments[0]?(new Date).getTime():arguments[0];for(var e in this.history)t-e-this.rememberFor>0&&delete this.history[e]}},{key:"clear",value:function(){this.history={}}},{key:"getTotal",value:function(){this.trimOld();var t=0;for(var e in this.history)t+=this.history[e];return t}}]),t}(),Layout=function(){function t(){_classCallCheck(this,t),this.template=Handlebars.compile(this.createLayout());var e=document.createElement("div");e.setAttribute("id","battle_eye_live");var i="width: 100%;position:relative;float:left;padding:10px;box-sizing: border-box;";i+='border-radius:0px 0px 20px 20px;background-image: url("http://i.imgur.com/XvYhBpp.png");background-color: rgb(48, 48, 48);',i+="color: #ffffff;text-shadow:0 1px 1px rgba(0, 0, 0, 0.4);",i+="background-image: ",e.setAttribute("style",i),document.getElementById("content").appendChild(e)}return _createClass(t,[{key:"update",value:function(t){null==t?t=this.lastData:this.lastData=t,t.version=GM_info.script.version;var e=this.template(t);document.getElementById("battle_eye_live").innerHTML=e}},{key:"createLayout",value:function(){var t="";return t+='<table style="width: 100%;table-layout: fixed;">',t+="<tr>",t+='<td style="text-align: right;">{{left.damage}}</td>',t+='<td style="text-align: center;">Total damage</td>',t+='<td style="text-align: left;">{{right.damage}}</td>',t+="</tr>",t+='<tr style="color:#cb1d1d;">',t+='<td style="text-align: right;">{{left.dps}}</td>',t+='<td style="text-align: center;"><i>Damage Per Second</i> (DPS)</td>',t+='<td style="text-align: left;">{{right.dps}}</td>',t+="</tr>",t+="<tr>",t+='<td style="text-align: right;">{{left.avgHit}}</td>',t+='<td style="text-align: center;">Average hit</td>',t+='<td style="text-align: left;">{{right.avgHit}}</td>',t+="</tr>",t+="<tr></tr>",t+='<tr style="color:#9e71f9;">',t+='<td style="text-align: right;">{{left.divisions.div4.damage}}</td>',t+='<td style="text-align: center;">Total D4 damage</td>',t+='<td style="text-align: left;">{{right.divisions.div4.damage}}</td>',t+="</tr>",t+="<tr>",t+='<td style="text-align: right;">{{left.divisions.div3.damage}}</td>',t+='<td style="text-align: center;">Total D3 damage</td>',t+='<td style="text-align: left;">{{right.divisions.div3.damage}}</td>',t+="</tr>",t+="<tr>",t+='<td style="text-align: right;">{{left.divisions.div2.damage}}</td>',t+='<td style="text-align: center;">Total D2 damage</td>',t+='<td style="text-align: left;">{{right.divisions.div2.damage}}</td>',t+="</tr>",t+="<tr>",t+='<td style="text-align: right;">{{left.divisions.div1.damage}}</td>',t+='<td style="text-align: center;">Total D1 damage</td>',t+='<td style="text-align: left;">{{right.divisions.div1.damage}}</td>',t+="</tr>",t+='<tr style="color:#9e71f9;">',t+='<td style="text-align: right;">{{left.divisions.div4.dps}}</td>',t+='<td style="text-align: center;">D4 DPS</td>',t+='<td style="text-align: left;">{{right.divisions.div4.dps}}</td>',t+="</tr>",t+="<tr>",t+='<td style="text-align: right;">{{left.divisions.div3.dps}}</td>',t+='<td style="text-align: center;">D3 DPS</td>',t+='<td style="text-align: left;">{{right.divisions.div3.dps}}</td>',t+="</tr>",t+="<tr>",t+='<td style="text-align: right;">{{left.divisions.div2.dps}}</td>',t+='<td style="text-align: center;">D2 DPS</td>',t+='<td style="text-align: left;">{{right.divisions.div2.dps}}</td>',t+="</tr>",t+="<tr>",t+='<td style="text-align: right;">{{left.divisions.div1.dps}}</td>',t+='<td style="text-align: center;">D1 DPS</td>',t+='<td style="text-align: left;">{{right.divisions.div1.dps}}</td>',t+="</tr>",t+="</table>",t+='<div style="text-align:left;color: rgb(4, 255, 14);font-weight:bold;">',t+="Battle Eye LIVE {{version}}",t+="</div>"}}]),t}(),Stats=function(t){function e(t){_classCallCheck(this,e);var i=_possibleConstructorReturn(this,Object.getPrototypeOf(e).call(this,10));return i.id=t,i.damage=0,i.hits=0,i.dps=0,i.divisions=new Divisions,i}return _inherits(e,t),_createClass(e,[{key:"isSide",value:function(t){return this.id==t}},{key:"updateDps",value:function(t){_get(Object.getPrototypeOf(e.prototype),"updateDps",this).call(this,t),this.divisions.updateDps(t)}},{key:"handle",value:function(t){this.isSide(t.side)&&(this.divisions.handle(t),this.addHit(t.msg.damage),this.hits++,this.damage+=t.msg.damage)}},{key:"toObject",value:function(){return{damage:this.damage.toLocaleString(),id:this.id,dps:this.dps.toLocaleString(),avgHit:Math.round(this.damage/this.hits).toLocaleString(),divisions:this.divisions.toObject()}}}]),e}(DpsHandler),Utils=function(){function t(){_classCallCheck(this,t)}return _createClass(t,[{key:"uid",value:function(){return("0000"+(Math.random()*Math.pow(36,4)<<0).toString(36)).slice(-4)}}]),t}(),UTILS=new Utils,battleEyeLive={init:function(){console.log("Battle Eye INIT"),"Tampermonkey"==GM_info.scriptHandler?this.window=unsafeWindow:this.window=window,this.events=new EventHandler,this.teamA=new Stats(this.window.leftBattleId),this.teamB=new Stats(this.window.rightBattleId),this.overridePomelo(),this.layout=new Layout,this.runTicker(),this.handleEvents()},getTeamStats:function(){return{left:this.teamA.toObject(),right:this.teamB.toObject()}},runTicker:function(){var t=this,e=0,i=function(){e++;var i={second:e,time:(new Date).getTime()};t.events.emit("tick",i)};t.interval=setInterval(i,1e3)},handleEvents:function(){var t=this;t.events.on("tick",function(e){t.teamA.updateDps(e),t.teamB.updateDps(e),t.layout.update(t.getTeamStats())})},overridePomelo:function(){var t=this;t.window.pomelo.on("onMessage",function(e){"Maximum"!==t.window.currentPlayerDisplayRateValue?t.window.battleFX.checkPlayerDisplayRate(t.window.currentPlayerDisplayRateValue)&&t.window.battleFX.populatePlayerData(e):t.window.battleFX.populatePlayerData(e),t.handle(e)})},handle:function(t){this.teamA.handle(t),this.teamB.handle(t),this.layout.update(this.getTeamStats())}};setTimeout(function(){function t(){var t=document.getElementById("cometchat_base");if(null!=t){var i="width:auto;position:aboslute;right:0;background:none;";t.setAttribute("style",i),clearInterval(e)}}battleEyeLive.init();var e=setInterval(t,500)},1e3);