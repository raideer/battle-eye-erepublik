// ==UserScript==
// @name        Battle Eye Live
// @namespace   battle-eye-live
// @author      Industrials / Raideer
// @homepage    https://github.com/raideer
// @description LIVE battlefield statistics
// @include     http*://www.erepublik.com/*/military/battlefield-new/*
// @version     1.1.5-a
// @require     https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.5/handlebars.min.js
// @require     https://googledrive.com/host/0B3BZg10JinisM29sa05qV0NyMmM/modals.min.js
// @resource    modals https://googledrive.com/host/0B3BZg10JinisM29sa05qV0NyMmM/modals.min.css
// @run-at      document-idle
// @grant       unsafeWindow
// @grant       GM_info
// @grant       GM_addStyle
// @grant       GM_getResourceText
// ==/UserScript==

"use strict";function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _get=function e(t,i,n){null===t&&(t=Function.prototype);var s=Object.getOwnPropertyDescriptor(t,i);if(void 0===s){var a=Object.getPrototypeOf(t);return null===a?void 0:e(a,i,n)}if("value"in s)return s.value;var l=s.get;if(void 0!==l)return l.call(n)},_createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),DpsHandler=function(){function e(t){_classCallCheck(this,e),this.rememberDpsFor=t,this.hitHistory=new HitHistory(1e3*t),this.hitStreakSeconds=0,this.lastHit=0,this.dps=0}return _createClass(e,[{key:"addHit",value:function(e){this.lastHit=(new Date).getTime(),this.hitHistory.add(e)}},{key:"updateDps",value:function(e){var t=this.hitHistory.getTotal();this.hitStreakSeconds<this.rememberDpsFor&&this.hitStreakSeconds++,this.dps=Math.round(t/this.hitStreakSeconds),e.time-this.lastHit>=1e4&&(this.hitHistory.clear(),this.hitStreakSeconds=0)}}]),e}(),Divisions=function(){function e(){_classCallCheck(this,e);this.divisions={}}return _createClass(e,[{key:"create",value:function(e,t){return this.divisions[e]=new DivisionStats(t),this.divisions[e]}},{key:"get",value:function(e){return this.divisions[e]}},{key:"handle",value:function(e){for(var t in this.divisions)this.divisions[t].handle(e)}},{key:"updateDps",value:function(e){for(var t in this.divisions)this.divisions[t].updateDps(e)}},{key:"toObject",value:function(){var e={};for(var t in this.divisions)e[t]=this.divisions[t].toObject();return e}}]),e}(),DivisionStats=function(e){function t(e){_classCallCheck(this,t);var i=_possibleConstructorReturn(this,Object.getPrototypeOf(t).call(this,10));return i.division=e,i.hits=0,i.damage=0,i}return _inherits(t,e),_createClass(t,[{key:"handle",value:function(e){e.division==this.division&&(this.addHit(e.msg.damage),this.hits++,this.damage+=e.msg.damage)}},{key:"toObject",value:function(){return{damage:this.damage,id:this.id,dps:this.dps,hits:this.hits,avgHit:Math.round(this.damage/this.hits)}}}]),t}(DpsHandler),EventHandler=function(){function e(){_classCallCheck(this,e),this.events={}}return _createClass(e,[{key:"emit",value:function(e,t){this.events[e]&&this.events[e].forEach(function(e){return e(t)})}},{key:"on",value:function(e,t){this.events[e]=this.events[e]||[],this.events[e].push(t)}},{key:"off",value:function(e,t){if(this.events[e])for(var i in this.events[e]){var n=this.events[e][i];n==t&&this.events[e].splice(i,1)}}}]),e}(),HitHistory=function(){function e(){var t=arguments.length<=0||void 0===arguments[0]?3e4:arguments[0];_classCallCheck(this,e),this.rememberFor=t,this.history={}}return _createClass(e,[{key:"add",value:function(e){var t=(new Date).getTime();this.history[t]=e,this.trimOld(t)}},{key:"trimOld",value:function(){var e=arguments.length<=0||void 0===arguments[0]?(new Date).getTime():arguments[0];for(var t in this.history)e-t-this.rememberFor>0&&delete this.history[t]}},{key:"clear",value:function(){this.history={}}},{key:"getTotal",value:function(){this.trimOld();var e=0;for(var t in this.history)e+=this.history[t];return e}}]),e}(),Layout=function(){function e(t,i,n){_classCallCheck(this,e);var s=this;s.settings=n,Handlebars.registerHelper("percentage",function(e,t,i){var n=0,s=0;return e+t!==0&&(n=Math.round(100*e/(e+t)*10)/10,s=Math.round(100*t/(e+t)*10)/10),i.fn({a:n,b:s})}),Handlebars.registerHelper("number",function(e){return parseFloat(e).toLocaleString()}),Handlebars.registerHelper("forEachDiv",function(e,t,i){var a=["air","div1","div2","div3","div4"],l=[[11,"Air"],[1,"Division 1"],[2,"Division 2"],[3,"Division 3"],[4,"Division 4"]],o=s.settings.all.showAverageDamage.value,r=s.settings.all.showKills.value,d=s.settings.all.showDpsBar.value,c=s.settings.all.showDamageBar.value,h=s.settings.all.hideOtherDivs.value,u=n.all.highlightDivision.value,f="";for(var v in a){var b=a[v],g=!1;h&&l[v][0]!=unsafeWindow.SERVER_DATA.division||(u&&l[v][0]==unsafeWindow.SERVER_DATA.division&&(g=!0),f+=i.fn({left:e.divisions[b],right:t.divisions[b],div:l[v][1],highlight:g,showAverage:o,showKills:r,showDpsBar:d,showDamageBar:c}))}return f}),s.feedTemplate=Handlebars.compile(s.compileFeed()),s.headerTemplate=Handlebars.compile(s.compileHeader()),s.settingsTemplate=Handlebars.compile(s.createSettingsModal());var a=document.createElement("div");a.setAttribute("id","battle_eye_live");var l=document.createElement("div");l.setAttribute("id","battle_eye_header");var o=document.createElement("div");o.setAttribute("id","battle_eye_feed"),a.appendChild(l),a.appendChild(o),document.getElementById("content").appendChild(a),t.load(),document.querySelector("#battle_eye_header").innerHTML=s.headerTemplate(i),document.querySelector("#battle_eye_live").innerHTML+=s.settingsTemplate(n),document.querySelector("#battle-eye-settings").addEventListener("click",function(){document.querySelector("#bel-settings-modal").classList.toggle("bel-hidden")}),document.querySelector("#bel-close-modal").addEventListener("click",function(){document.querySelector("#bel-settings-modal").classList.add("bel-hidden")})}return _createClass(e,[{key:"update",value:function(e){null===e?e=this.lastData:this.lastData=e;var t=this.feedTemplate(e);document.getElementById("battle_eye_feed").innerHTML=t}},{key:"createSettingsModal",value:function(){return'\n            <div id="bel-settings-modal" class="bel-settings bel-hidden">\n                <button id="bel-close-modal" class="bel-btn bel-btn-default" style="margin-top: -3px;float:right;">Close</button>\n                <div class="bel-grid">\n                    <div class="bel-col-1-2">\n                        {{#each all}}\n                            <div class="bel-checkbox">\n                                <input type="checkbox" class="bel-settings-field"\n                                {{#if value}}\n                                    checked\n                                {{/if}}\n                                id="{{field.field}}" name="{{field.field}}">\n                                <label for="{{field.field}}">\n                                    {{field.name}}\n                                </label>\n                                <div class="bel-field-description">\n                                    {{field.desc}}\n                                </div>\n                            </div>\n                        {{/each}}\n                    </div>\n                </div>\n            </div>\n        '}},{key:"compileHeader",value:function(){var e='\n            <ul class="list-unstyled list-inline text-left bel-header-menu" style="padding-bottom:6px; border-bottom: 1px solid #ecf0f1;">\n                <li>\n                    <span class="bel-version">{{version}}</span> BATTLE EYE LIVE\n                </li>\n\n                <li style="float:right;">\n                    <button id="battle-eye-settings" class="bel-btn bel-btn-default" style="margin-top: -3px;">Settings</button>\n                </li>\n            </ul>\n\n            <div class="bel-grid">\n                <div class="bel-col-1-2 text-left" style="color:#27ae60;font-weight:700;font-size:1.3em;">\n                    {{teamAName}}\n                </div>\n                <div class="bel-col-1-2 text-right" style="color:#c0392b;font-weight:700;font-size:1.3em;">\n                    {{teamBName}}\n                </div>\n            </div>\n        ';return e}},{key:"compileFeed",value:function(){var e='\n            <div class="bel-grid">\n                {{#forEachDiv left right}}\n                    <div class="bel-col-1-1 text-center bel-title\n                    {{#if highlight}}\n                        bel-highlight-title\n                    {{/if}}\n                    ">\n                        {{div}}\n                    </div>\n                    <div class="bel-col-1-3 text-right">\n                        <ul class="list-unstyled">\n                            <li>\n                                {{#if showKills}}\n                                    <span class="bel-value">{{number left.hits}} kills</span>\n                                {{/if}}\n                                <span class="bel-value">{{number left.damage}}</span>\n                            </li>\n\n                            {{#if showAverage}}\n                                <li><span class="bel-value">{{number left.avgHit}}</span></li>\n                            {{/if}}\n\n                            <li><span class="bel-value">{{number left.dps}}</span></li>\n                        </ul>\n                    </div>\n                    <div class="bel-col-1-3 text-center">\n                        <ul class="list-unstyled\n                        {{#if highlight}}\n                            bel-highlight\n                        {{/if}}\n                        " style="font-weight:700;">\n                            <li>Total Damage</li>\n                            {{#if showAverage}}\n                                <li>Average Damage</li>\n                            {{/if}}\n                            <li>DPS</li>\n                        </ul>\n                    </div>\n                    <div class="bel-col-1-3 text-left">\n                        <ul class="list-unstyled">\n                            <li>\n                                <span class="bel-value">{{number right.damage}}</span>\n                                {{#if showKills}}\n                                    <span class="bel-value">{{number right.hits}} kills</span>\n                                {{/if}}\n                            </li>\n                            {{#if showAverage}}\n                                <li><span class="bel-value">{{number right.avgHit}}</span></li>\n                            {{/if}}\n                            <li><span class="bel-value">{{number right.dps}}</span></li>\n                        </ul>\n                    </div>\n                    <div class="bel-col-1-1">\n                        {{#if showDamageBar}}\n                            <div class="bel-progress">\n                                <div class="bel-progress-center-marker"></div>\n                                {{#percentage left.damage right.damage}}\n                                    <div class="bel-progress-bar bel-teama" style="width: {{a}}%;"></div>\n                                    <div class="bel-progress-bar bel-teamb" style="width: {{b}}%;"></div>\n                                {{/percentage}}\n                            </div>\n                        {{/if}}\n                        {{#if showDpsBar}}\n                            <div class="bel-progress">\n                                <div class="bel-progress-center-marker"></div>\n                                {{#percentage left.dps right.dps}}\n                                    <div class="bel-progress-bar bel-teama" style="width: {{a}}%;"></div>\n                                    <div class="bel-progress-bar bel-teamb" style="width: {{b}}%;"></div>\n                                {{/percentage}}\n\n                            </div>\n                        {{/if}}\n                    </div>\n                {{/forEachDiv}}\n            </div>\n        ';return e}}]),e}(),Settings=function(){function e(){_classCallCheck(this,e);var t=this;return t.checkIfStorageAvailable()?(t.prepend="battle_eye_",void(t.fields={})):!1}return _createClass(e,[{key:"set",value:function(e,t){var i=this;localStorage.setItem(""+i.prepend+e,t),console.log(""+i.prepend+e+" = "+t)}},{key:"get",value:function(e){var t=this,i=localStorage.getItem(""+t.prepend+e);switch(i){case"true":i=!0;break;case"false":i=!1}return i}},{key:"has",value:function(e){var t=this;return!!localStorage.getItem(""+t.prepend+e)}},{key:"define",value:function(e,t,i,n){var s=this;void 0===s.fields[e]&&(s.fields[e]={field:e,name:i,desc:n}),s.has(e)||s.set(e,t)}},{key:"getAll",value:function(){var e=this,t={};for(var i in e.fields){var n=e.fields[i];t[i]={field:n,value:e.get(n.field)}}return t}},{key:"checkIfStorageAvailable",value:function(){return"undefined"!=typeof Storage}}]),e}(),Stats=function(e){function t(e){_classCallCheck(this,t);var i=_possibleConstructorReturn(this,Object.getPrototypeOf(t).call(this,10));return i.id=e,i.damage=0,i.hits=0,i.constructDivisions(),i}return _inherits(t,e),_createClass(t,[{key:"constructDivisions",value:function(){this.divisions=new Divisions,this.divisions.create("div1",1),this.divisions.create("div2",2),this.divisions.create("div3",3),this.divisions.create("div4",4),this.divisions.create("air",11)}},{key:"isSide",value:function(e){return this.id==e}},{key:"updateDps",value:function(e){_get(Object.getPrototypeOf(t.prototype),"updateDps",this).call(this,e),this.divisions.updateDps(e)}},{key:"handle",value:function(e){this.isSide(e.side)&&(this.divisions.handle(e),this.addHit(e.msg.damage),this.hits++,this.damage+=e.msg.damage)}},{key:"toObject",value:function(){return{damage:this.damage,id:this.id,dps:this.dps,hits:this.hits,avgHit:Math.round(this.damage/this.hits),divisions:this.divisions.toObject()}}}]),t}(DpsHandler),Stylesheet=function(){function e(){_classCallCheck(this,e),this.sheet="",this.addCSSRule("#battle_eye_live",'\n            width: 100%;\n            position:relative;\n            float:left;\n            padding:10px;\n            box-sizing: border-box;\n            border-radius:0px 0px 20px 20px;\n            background-color: #ffffff;\n            color: #34495e;\n            font-size:14px;\n            font-family: "Lato",\n            Helvetica,Arial,sans-serif;\n            text-align: center;\n            line-height: 1.7;\n        '),this.addCSSRule("#battle_eye_live *,#battle_eye_live *:after,#battle_eye_live *:before","-webkit-box-sizing: border-box;-moz-box-sizing: border-box;box-sizing: border-box;"),this.addCSSRule(".bel-value","background-color: #ecf0f1;padding: 2px 10px;border-radius: 4px;margin: 0 2px;"),this.addCSSRule(".text-center","text-align:center;"),this.addCSSRule(".text-left","text-align:left;"),this.addCSSRule(".text-right","text-align:right;"),this.addCSSRule(".bel-version","background-color: #34495e;color:#ecf0f1;padding: 3px 8px;border-radius:4px;margin-right:4px;"),this.addCSSRule(".bel-title","background-color: #ecf0f1;margin-bottom:2px;margin-top:5px;"),this.addCSSRule(".bel-highlight-title","\n            background-color: #9b59b6;\n            color: #fff;\n        "),this.addCSSRule(".bel-highlight","\n            color: #8e44ad;\n        "),this.addCSSRule(".bel-grid:after",'content: "";display: table;clear: both;'),this.addCSSRule("[class*='bel-col-']","float: left;"),this.addCSSRule(".bel-col-1-1","width: 100%;"),this.addCSSRule(".bel-col-1-2","width: 50%;"),this.addCSSRule(".bel-col-1-4","width: 25%;"),this.addCSSRule(".bel-col-1-3","width: 33.3333%;"),this.addCSSRule(".bel-col-1-8","width: 12.5%;"),this.addCSSRule(".list-unstyled","list-style: outside none none;padding-left: 0;"),this.addCSSRule(".list-inline li","display: inline-block;"),this.addCSSRule(".bel-settings","\n            z-index: 100;\n            position: absolute;\n            width: 100%;\n            height: 100%;\n            opacity: 0.95;\n            top: 0;\n            left: 0;\n            background-color: #ffffff;\n            padding: 14px;\n            text-align: left;\n            overflow-y: scroll;\n        "),this.addCSSRule(".bel-field-description","\n            font-size: 12px;\n            color: #95a5a6;\n        "),this.addCSSRule(".bel-checkbox","\n            padding-bottom: 5px;\n            padding-top: 5px;\n            border-bottom: 1px solid #ecf0f1;\n        "),this.addCSSRule(".bel-hidden","\n            display: none;\n        "),this.addCSSRule(".bel-btn","\n            -moz-user-select: none;\n            background-image: none;\n            border: medium none;\n            cursor: pointer;\n            font-size: 14px;\n            font-weight: normal;\n            margin-bottom: 0;\n            text-align: center;\n            border-radius: 4px;\n            font-size: 12px;\n            padding: 3px 8px;\n        "),this.addCSSRule(".bel-btn-default","\n            background-color: #1abc9c;\n            color: #ffffff;\n        "),this.addCSSRule(".bel-btn-default:hover","\n            background-color: #16a085;\n            color: #ffffff;\n        "),this.addCSSRule(".bel-header-menu","margin-bottom: 10px;"),this.addCSSRule(".bel-header-menu li","padding: 0 5px;"),this.addCSSRule(".bel-progress","\n            height: 4px;\n            position: relative;\n            background: #ebedef none repeat scroll 0 0;\n            border-radius: 32px;\n            box-shadow: none;\n            margin-top: 2px;\n            overflow: hidden;\n        "),this.addCSSRule(".bel-teama","background-color: #27ae60;"),this.addCSSRule(".bel-teamb","background-color: #c0392b;"),this.addCSSRule(".bel-progress-bar","\n            box-shadow: none;\n            line-height: 12px;\n            color: #fff;\n            float: left;\n            font-size: 12px;\n            height: 100%;\n            line-height: 20px;\n            text-align: center;\n            transition: width 0.6s ease 0s;\n            width: 0;\n        "),this.addCSSRule(".bel-progress-center-marker","\n            border-right: 3px solid #ffffff;\n            height: 10px;\n            left: 50%;\n            margin-left: -2px;\n            opacity: 0.6;\n            position: absolute;\n        "),this.addCSSRule(".bel-hr","\n            -moz-border-bottom-colors: none;\n            -moz-border-left-colors: none;\n            -moz-border-right-colors: none;\n            -moz-border-top-colors: none;\n            border-color: #eee -moz-use-text-color -moz-use-text-color;\n            border-image: none;\n            border-style: solid none none;\n            border-width: 1px 0 0;\n            margin-bottom: 20px;\n        ")}return _createClass(e,[{key:"addCSSRule",value:function(e,t){this.sheet+=e+"{"+t+"}"}},{key:"load",value:function(){GM_addStyle(GM_getResourceText("modals")),GM_addStyle(this.sheet)}}]),e}(),Utils=function(){function e(){_classCallCheck(this,e)}return _createClass(e,[{key:"uid",value:function(){return("0000"+(Math.random()*Math.pow(36,4)<<0).toString(36)).slice(-4)}}]),e}(),UTILS=new Utils,battleEyeLive={init:function(){var e=this;console.log("Battle Eye INIT"),e.window=unsafeWindow;var t=e.settingsStorage=new Settings;return t===!1?console.error("LocalStorage is not available! Battle Eye initialisation canceled"):(t.define("hideOtherDivs",!1,"Hide other divisions"),t.define("reduceLoad",!1,"Render every second","Stats will be refreshed every second instead of after every kill. This can improve performance"),t.define("highlightDivision",!0,"Highlight current division"),t.define("showAverageDamage",!1,"Show average damage dealt"),t.define("showKills",!0,"Show kills done by each division"),t.define("showDpsBar",!0,"Show DPS bar"),t.define("showDamageBar",!1,"Show Damage bar"),e.settings=t.getAll(),e.events=new EventHandler,e.teamA=new Stats(e.window.SERVER_DATA.leftBattleId),e.teamAName=this.window.SERVER_DATA.countries[e.window.SERVER_DATA.leftBattleId],e.teamB=new Stats(e.window.SERVER_DATA.rightBattleId),e.teamBName=this.window.SERVER_DATA.countries[e.window.SERVER_DATA.rightBattleId],e.overridePomelo(),e.layout=new Layout(new Stylesheet,{teamAName:this.teamAName,teamBName:this.teamBName,version:GM_info.script.version},{all:e.settings}),[].forEach.call(document.querySelectorAll(".bel-settings-field"),function(t){t.addEventListener("change",function(t){var i=t.target;i.checked;e.settingsStorage.set(i.name,i.checked),e.settings[i.name].value=i.checked})}),e.runTicker(),void e.handleEvents())},getTeamStats:function(){return{left:this.teamA.toObject(),right:this.teamB.toObject()}},runTicker:function(){var e=this,t=0,i=function(){t++;var i={second:t,time:(new Date).getTime()};e.events.emit("tick",i)};e.interval=setInterval(i,1e3)},handleEvents:function(){var e=this;e.events.on("tick",function(t){e.teamA.updateDps(t),e.teamB.updateDps(t),e.layout.update(e.getTeamStats())})},overridePomelo:function(){var e=this,t=function(t){"Maximum"!==e.window.currentPlayerDisplayRateValue?e.window.battleFX.checkPlayerDisplayRate(e.window.currentPlayerDisplayRateValue)&&e.window.battleFX.populatePlayerData(t):e.window.battleFX.populatePlayerData(t),e.handle(t)};e.window.pomelo.on("onMessage",exportFunction(t,unsafeWindow))},handle:function(e){var t=this;t.teamA.handle(e),t.teamB.handle(e),t.settings.reduceLoad.value||t.layout.update(t.getTeamStats())}};setTimeout(function(){function e(){var e=document.getElementById("cometchat_base");if(null!==e){var i="width:auto;position:aboslute;right:0;background:none;";e.setAttribute("style",i),clearInterval(t)}}battleEyeLive.init();var t=setInterval(e,500)},2e3);