// ==UserScript==
// @name        Battle Eye Live
// @namespace   battle-eye-live
// @author      Industrials
// @homepage    https://docs.google.com/spreadsheets/d/1Ebqp5Hb8KmGvX6X0FXmALO30Fv-IyfJHUGPkjKey8tg
// @description LIVE battlefield statistics
// @include     http*://www.erepublik.com/*/military/battlefield-new/*
// @version     1.2.6
// @require     https://fb.me/react-15.2.1.min.js
// @require     https://fb.me/react-dom-15.2.1.min.js
// @require     https://cdnjs.cloudflare.com/ajax/libs/async/2.0.1/async.min.js
// @require     https://googledrive.com/host/0B3BZg10JinisM29sa05qV0NyMmM/notify.js
// @run-at      document-idle
// @grant       none
// @noframes
// ==/UserScript==

"use strict";function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _get=function e(t,a,n){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,a);if(void 0===i){var s=Object.getPrototypeOf(t);return null===s?void 0:e(s,a,n)}if("value"in i)return i.value;var l=i.get;if(void 0!==l)return l.call(n)},_createClass=function(){function e(e,t){for(var a=0;a<t.length;a++){var n=t[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,a,n){return a&&e(t.prototype,a),n&&e(t,n),t}}(),DpsHandler=function(){function e(t){_classCallCheck(this,e),this.rememberDpsFor=t,this.hitHistory=new HitHistory(1e3*t),this.hitStreakSeconds=0,this.lastHit=0,this.dps=0}return _createClass(e,[{key:"addHit",value:function(e){this.lastHit=(new Date).getTime(),this.hitHistory.add(e)}},{key:"updateDps",value:function(e){var t=this.hitHistory.getTotal();this.hitStreakSeconds<this.rememberDpsFor&&this.hitStreakSeconds++,this.dps=Math.round(t/this.hitStreakSeconds),e.time-this.lastHit>=1e4&&(this.hitHistory.clear(),this.hitStreakSeconds=0)}}]),e}(),Feed=function(e){function t(){return _classCallCheck(this,t),_possibleConstructorReturn(this,Object.getPrototypeOf(t).apply(this,arguments))}return _inherits(t,e),_createClass(t,[{key:"printDivisions",value:function(){if(!this.props.data)return null;var e=[];if(11==SERVER_DATA.division)var t=[[11,"Air Division"]];else var t=[[1,"Division 1"],[2,"Division 2"],[3,"Division 3"],[4,"Division 4"]];for(var a in t){var n=t[a];if((this.props.settings.showOtherDivs.value||n[0]==SERVER_DATA.division)&&(this.props.settings.showDiv1.value||1!=n[0])&&(this.props.settings.showDiv2.value||2!=n[0])&&(this.props.settings.showDiv3.value||3!=n[0])&&(this.props.settings.showDiv4.value||4!=n[0])){var i={};i.left=this.props.data.left.divisions["div"+n[0]],i.right=this.props.data.right.divisions["div"+n[0]],e.push(React.createElement(FeedDivision,{data:i,div:n,settings:this.props.settings}))}}return e}},{key:"printOverall",value:function(){var e={};return e.left=this.props.data.left,e.right=this.props.data.right,React.createElement(FeedOverall,{data:e,settings:this.props.settings})}},{key:"getContent",value:function(){return"div"==this.props.tab?this.printDivisions():(this.props.tab="overall")?this.printOverall():void 0}},{key:"render",value:function(){return React.createElement("div",{className:"bel-grid"},this.getContent())}}]),t}(React.Component),FeedDivision=function(e){function t(){return _classCallCheck(this,t),_possibleConstructorReturn(this,Object.getPrototypeOf(t).apply(this,arguments))}return _inherits(t,e),_createClass(t,[{key:"getPerc",value:function(e,t){var a=0;return e+t!=0&&(a=Math.round(100*e/(e+t))),a}},{key:"render",value:function(){var e=this.props.data.left,t=this.props.data.right,a=this.props.settings,n=!1;return a.highlightDivision.value&&SERVER_DATA.division==this.props.div[0]&&(n=!0),React.createElement("div",null,React.createElement("div",{className:"bel-col-1-1 text-center bel-title "+(n?"bel-highlight-title":"")},this.props.div[1]),React.createElement("div",{className:"bel-col-1-3 text-right"},React.createElement("ul",{className:"list-unstyled"},React.createElement("li",null,React.createElement(If,{test:a.showKills.value},React.createElement(FeedValue,{a:e.hits,b:t.hits,highlight:a.highlightValue.value,text:"kills"})),React.createElement(If,{test:a.showDamagePerc.value},React.createElement(FeedValue,{a:this.getPerc(e.damage,t.damage),b:this.getPerc(t.damage,e.damage),highlight:a.highlightValue.value,text:"%"})),React.createElement(FeedValue,{a:e.damage,b:t.damage,highlight:a.highlightValue.value})),React.createElement(If,{test:a.showAverageDamage.value},React.createElement("li",null,React.createElement(FeedValue,{a:e.avgHit,b:t.avgHit,highlight:a.highlightValue.value}))),React.createElement("li",null,React.createElement(FeedValue,{a:e.dps,b:t.dps,highlight:a.highlightValue.value})))),React.createElement("div",{className:"bel-col-1-3 text-center"},React.createElement("ul",{className:"list-unstyled bel-titles "+(n?"bel-highlight":"")},React.createElement("li",null,"Total Damage"),React.createElement(If,{test:a.showAverageDamage.value},React.createElement("li",null,"Average Damage")),React.createElement("li",null,"DPS"))),React.createElement("div",{className:"bel-col-1-3 text-left"},React.createElement("ul",{className:"list-unstyled"},React.createElement("li",null,React.createElement(FeedValue,{a:t.damage,b:e.damage,highlight:a.highlightValue.value}),React.createElement(If,{test:a.showDamagePerc.value},React.createElement(FeedValue,{b:this.getPerc(e.damage,t.damage),a:this.getPerc(t.damage,e.damage),highlight:a.highlightValue.value,text:"%"})),React.createElement(If,{test:a.showKills.value},React.createElement(FeedValue,{a:t.hits,b:e.hits,text:"kills",highlight:a.highlightValue.value}))),React.createElement(If,{test:a.showAverageDamage.value},React.createElement("li",null,React.createElement(FeedValue,{a:t.avgHit,b:e.avgHit,highlight:a.highlightValue.value}))),React.createElement("li",null,React.createElement(FeedValue,{a:t.dps,b:e.dps,highlight:a.highlightValue.value})))),React.createElement("div",{className:"bel-col-1-1"},React.createElement(If,{test:a.showDamageBar.value},React.createElement("div",{className:"text-left bel-text-tiny"},"DAMAGE ",React.createElement("span",{className:"color-silver"},"(",React.createElement("strong",null,Math.abs(e.damage-t.damage).toLocaleString()," ")," difference)")),React.createElement(FeedProgressBar,{a:e.damage,b:t.damage})),React.createElement(If,{test:a.showDpsBar.value},React.createElement(FeedProgressBar,{a:e.dps,b:t.dps}),React.createElement("div",{className:"text-left bel-text-tiny"},"DPS ",React.createElement("span",{className:"color-silver"},"(",React.createElement("strong",null,Math.abs(e.dps-t.dps).toLocaleString())," difference)")))))}}]),t}(React.Component),FeedOverall=function(e){function t(){return _classCallCheck(this,t),_possibleConstructorReturn(this,Object.getPrototypeOf(t).apply(this,arguments))}return _inherits(t,e),_createClass(t,[{key:"getPerc",value:function(e,t){var a=0;return e+t!=0&&(a=Math.round(100*e/(e+t))),a}},{key:"render",value:function(){var e=this.props.data.left,t=this.props.data.right,a=this.props.settings;return React.createElement("div",null,React.createElement("div",{className:"bel-col-1-1 text-center bel-title bel-highlight-title"},"Overall stats"),React.createElement("div",{className:"bel-col-1-3 text-right"},React.createElement("ul",{className:"list-unstyled"},React.createElement("li",null,React.createElement(If,{test:a.showKills.value},React.createElement(FeedValue,{a:e.hits,b:t.hits,highlight:a.highlightValue.value,text:"kills"})),React.createElement(If,{test:a.showDamagePerc.value},React.createElement(FeedValue,{a:this.getPerc(e.damage,t.damage),b:this.getPerc(t.damage,e.damage),highlight:a.highlightValue.value,text:"%"})),React.createElement(FeedValue,{a:e.damage,b:t.damage,highlight:a.highlightValue.value})),React.createElement(If,{test:a.showAverageDamage.value},React.createElement("li",null,React.createElement(FeedValue,{a:e.avgHit,b:t.avgHit,highlight:a.highlightValue.value}))),React.createElement("li",null,React.createElement(FeedValue,{a:e.dps,b:t.dps,highlight:a.highlightValue.value})))),React.createElement("div",{className:"bel-col-1-3 text-center"},React.createElement("ul",{className:"list-unstyled bel-titles"},React.createElement("li",null,"Total Damage"),React.createElement(If,{test:a.showAverageDamage.value},React.createElement("li",null,"Average Damage")),React.createElement("li",null,"DPS"))),React.createElement("div",{className:"bel-col-1-3 text-left"},React.createElement("ul",{className:"list-unstyled"},React.createElement("li",null,React.createElement(FeedValue,{a:t.damage,b:e.damage,highlight:a.highlightValue.value}),React.createElement(If,{test:a.showDamagePerc.value},React.createElement(FeedValue,{b:this.getPerc(e.damage,t.damage),a:this.getPerc(t.damage,e.damage),highlight:a.highlightValue.value,text:"%"})),React.createElement(If,{test:a.showKills.value},React.createElement(FeedValue,{a:t.hits,b:e.hits,text:"kills",highlight:a.highlightValue.value}))),React.createElement(If,{test:a.showAverageDamage.value},React.createElement("li",null,React.createElement(FeedValue,{a:t.avgHit,b:e.avgHit,highlight:a.highlightValue.value}))),React.createElement("li",null,React.createElement(FeedValue,{a:t.dps,b:e.dps,highlight:a.highlightValue.value})))),React.createElement("div",{className:"bel-col-1-1"},React.createElement(If,{test:a.showDamageBar.value},React.createElement("div",{className:"text-left bel-text-tiny"},"DAMAGE ",React.createElement("span",{className:"color-silver"},"(",React.createElement("strong",null,Math.abs(e.damage-t.damage).toLocaleString()," ")," difference)")),React.createElement(FeedProgressBar,{a:e.damage,b:t.damage})),React.createElement(If,{test:a.showDpsBar.value},React.createElement(FeedProgressBar,{a:e.dps,b:t.dps}),React.createElement("div",{className:"text-left bel-text-tiny"},"DPS ",React.createElement("span",{className:"color-silver"},"(",React.createElement("strong",null,Math.abs(e.dps-t.dps).toLocaleString())," difference)")))))}}]),t}(React.Component),FeedProgressBar=function(e){function t(){return _classCallCheck(this,t),_possibleConstructorReturn(this,Object.getPrototypeOf(t).apply(this,arguments))}return _inherits(t,e),_createClass(t,[{key:"render",value:function(){var e=0,t=0;this.props.a+this.props.b!==0&&(e=Math.round(100*this.props.a/(this.props.a+this.props.b)),t=Math.round(100*this.props.b/(this.props.a+this.props.b)));var a={width:e+"%"},n={width:t+"%"},i={};return settings.largerBars.value&&(i.height="8px"),React.createElement("div",{className:"bel-progress",style:i},React.createElement("div",{className:"bel-progress-center-marker"}),React.createElement("div",{className:"bel-progress-bar bel-teama",style:a}),React.createElement("div",{className:"bel-progress-bar bel-teamb",style:n}))}}]),t}(React.Component),FeedValue=function(e){function t(){_classCallCheck(this,t);var e=_possibleConstructorReturn(this,Object.getPrototypeOf(t).call(this));return e.props={text:""},e}return _inherits(t,e),_createClass(t,[{key:"render",value:function(){return React.createElement("span",{className:"bel-value "+(this.props.a>this.props.b&&this.props.highlight?"bel-value-hl":"")},parseFloat(this.props.a).toLocaleString()," ",this.props.text)}}]),t}(React.Component),Footer=function(e){function t(){return _classCallCheck(this,t),_possibleConstructorReturn(this,Object.getPrototypeOf(t).apply(this,arguments))}return _inherits(t,e),_createClass(t,[{key:"render",value:function(){return null}}]),t}(React.Component),Header=function(e){function t(){return _classCallCheck(this,t),_possibleConstructorReturn(this,Object.getPrototypeOf(t).apply(this,arguments))}return _inherits(t,e),_createClass(t,[{key:"getTeamElementStyle",value:function(){return{fontWeight:700,fontSize:"1.3em"}}},{key:"getHeaderListStyle",value:function(){return{paddingBottom:"6px",borderBottom:"1px solid #ecf0f1"}}},{key:"getFlagStyle",value:function(e){return{backgroundImage:"url('/images/flags_png/L/"+e+".png')",backgroundPosition:"-4px -4px"}}},{key:"render",value:function(){return React.createElement("div",{id:"battle_eye_header"},React.createElement("ul",{className:"list-unstyled list-inline text-left bel-header-menu",style:this.getHeaderListStyle()},React.createElement("li",{id:"bel-version"},React.createElement("span",{className:"bel-version"},this.props.data.version)," ",React.createElement("a",{href:"http://bit.ly/BattleEye",target:"_blank"},"BATTLE EYE")),React.createElement("li",{id:"bel-loading"},React.createElement("div",{className:"bel-spinner"},React.createElement("div",{className:"rect1"}),React.createElement("div",{className:"rect2"}),React.createElement("div",{className:"rect3"}),React.createElement("div",{className:"rect4"}),React.createElement("div",{className:"rect5"}))),React.createElement("li",{className:"pull-right"},React.createElement("ul",{className:"list-unstyled list-inline"},React.createElement("li",null,React.createElement("a",{className:"bel-btn bel-btn-inverse",target:"_blank",href:"http://www.erepublik.com/en/citizen/profile/8075739"},"Contact/Donate")),React.createElement("li",null,React.createElement("button",{id:"battle-eye-settings",onClick:this.props.openModal,className:"bel-btn bel-btn-default"},"Settings"))))),React.createElement("div",{className:"bel-grid"},React.createElement("div",{className:"bel-col-1-2 text-left bel-teama-color",style:this.getTeamElementStyle()},React.createElement("div",{style:this.getFlagStyle(this.props.data.teamAName),className:"bel-country"})," ",this.props.data.teamAName),React.createElement("div",{className:"bel-col-1-2 text-right bel-teamb-color",style:this.getTeamElementStyle()},this.props.data.teamBName," ",React.createElement("div",{style:this.getFlagStyle(this.props.data.teamBName),className:"bel-country"}))))}}]),t}(React.Component),If=function(e){function t(){return _classCallCheck(this,t),_possibleConstructorReturn(this,Object.getPrototypeOf(t).apply(this,arguments))}return _inherits(t,e),_createClass(t,[{key:"render",value:function(){return this.props.test?React.createElement("span",null,this.props.children):null}}]),t}(React.Component),SettingsField=function(e){function t(){return _classCallCheck(this,t),_possibleConstructorReturn(this,Object.getPrototypeOf(t).apply(this,arguments))}return _inherits(t,e),_createClass(t,[{key:"getInput",value:function(){var e=this.props.setting;return"boolean"==typeof e.value?React.createElement("div",null,React.createElement("input",{type:"checkbox",defaultChecked:e.value,className:"bel-settings-field",id:e.field.id,name:e.field.id}),React.createElement("label",{htmlFor:e.field.id},e.field.name)):React.createElement("div",null,React.createElement("label",{htmlFor:e.field.id},e.field.name),React.createElement("div",null,React.createElement("input",{type:"text",defaultValue:e.value,className:"bel-settings-field",id:e.field.id,name:e.field.id})))}},{key:"render",value:function(){var e=this.props.setting;return React.createElement("div",{className:"bel-checkbox"},this.getInput(),React.createElement("div",{className:"bel-field-description"},e.field.desc))}}]),t}(React.Component),SettingsGroup=function(e){function t(){return _classCallCheck(this,t),_possibleConstructorReturn(this,Object.getPrototypeOf(t).apply(this,arguments))}return _inherits(t,e),_createClass(t,[{key:"renderSettings",value:function(){var e=this.props.settings,t=[];for(var a in e){var n=e[a];t.push(React.createElement(SettingsField,{setting:n}))}return t}},{key:"render",value:function(){return React.createElement("div",{className:"bel-col-1-2"},React.createElement("h5",{className:"bel-settings-group"},this.props.name),React.createElement("div",{className:"bel-settings-container"},this.renderSettings()))}}]),t}(React.Component),SettingsModal=function(e){function t(){return _classCallCheck(this,t),_possibleConstructorReturn(this,Object.getPrototypeOf(t).apply(this,arguments))}return _inherits(t,e),_createClass(t,[{key:"renderGroups",value:function(){var e=this.props.settings,t=[],a={};for(var n in e){var i=e[n];void 0==a[i.field.group]&&(a[i.field.group]=[]),a[i.field.group].push(i)}for(var n in a){var s=a[n];t.push(React.createElement(SettingsGroup,{name:n,settings:s}))}return t}},{key:"resetSettings",value:function(){battleEyeLive.resetSettings(),$j("#bel-reset-settings").notify("Settings reset","info")}},{key:"render",value:function(){return React.createElement("div",{id:"bel-settings-modal",className:"bel-settings "+(this.props.hidden?"bel-hidden":"")},React.createElement("div",{className:"clearfix"},React.createElement("ul",{className:"list-unstyled list-inline pull-right bel-header-menu"},React.createElement("li",null,React.createElement("a",{id:"bel-reset-settings",onClick:this.resetSettings,href:"javascript:void(0);",className:"bel-btn bel-btn-inverse bel-btn-alert-success"},"Reset to defaults")),React.createElement("li",null,React.createElement("a",{href:"https://googledrive.com/host/0B3BZg10JinisM29sa05qV0NyMmM/battle-eye-live.user.js",className:"bel-btn bel-btn-inverse"},"Update")),React.createElement("li",null,React.createElement("button",{id:"bel-close-modal",onClick:this.props.closeModal,className:"bel-btn bel-btn-danger"},"Close")))),React.createElement("div",{className:"bel-grid"},this.renderGroups()))}}]),t}(React.Component),TabSelector=function(e){function t(){return _classCallCheck(this,t),_possibleConstructorReturn(this,Object.getPrototypeOf(t).apply(this,arguments))}return _inherits(t,e),_createClass(t,[{key:"getStyle",value:function(e){return this.props.tab==e?"bel-btn bel-btn-default":"bel-btn bel-btn-grey"}},{key:"render",value:function(){return React.createElement("div",{className:"bel-tabs"},React.createElement("button",{onClick:this.props.changeTab.bind(this,"div"),className:this.getStyle("div")},"Divisions"),React.createElement("button",{onClick:this.props.changeTab.bind(this,"overall"),className:this.getStyle("overall")},"Overall"))}}]),t}(React.Component),Template=function(e){function t(){_classCallCheck(this,t);var e=_possibleConstructorReturn(this,Object.getPrototypeOf(t).call(this));return e.state={modalHidden:!0,tab:"div"},e}return _inherits(t,e),_createClass(t,[{key:"openModal",value:function(){this.setState({modalHidden:!1})}},{key:"closeModal",value:function(){this.setState({modalHidden:!0})}},{key:"changeTab",value:function(e){this.setState({tab:e})}},{key:"render",value:function(){return React.createElement("div",null,React.createElement(SettingsModal,{closeModal:this.closeModal.bind(this),hidden:this.state.modalHidden,settings:this.props.settings}),React.createElement(Header,{openModal:this.openModal.bind(this),data:this.props.headerData}),React.createElement(TabSelector,{changeTab:this.changeTab.bind(this),tab:this.state.tab}),React.createElement(Feed,{data:this.props.feedData,settings:this.props.settings,tab:this.state.tab}),React.createElement(Footer,null))}}]),t}(React.Component),Module=function(){function e(t,a){_classCallCheck(this,e);var n=this;n.name=t,n.desc=a}return _createClass(e,[{key:"defineSettings",value:function(){return[]}},{key:"run",value:function(e){return null}}]),e}(),AutoShooter=function(e){function t(){return _classCallCheck(this,t),_possibleConstructorReturn(this,Object.getPrototypeOf(t).call(this,"AutoShooter","Automatically shoots, when the FIGHT button is held"))}return _inherits(t,e),_createClass(t,[{key:"defineSettings",value:function(){return[["autoShooterEnabled",!1,"Enable AutoShooter","Automatically shoots, when the FIGHT button is held"],["autoShooterStart",!1,"Start AutoShooter immediately after the button is pressed.","Otherwise, AutoShooter will start after the shot delay"],["autoShooterEnter",!0,"Shoot while holding ENTER"],["autoShooterSpace",!0,"Shoot while holding SPACE"],["autoShooterDelay",1500,"Delay between shots (in ms)"]]}},{key:"run",value:function(){function e(e){return(""+e).replace(/\B(?=(\d{3})+(?!\d))/g,",")}var t,a;document.getElementById("fight_btn").addEventListener("mousedown",function(){n()}),document.onkeydown=function(e){a&&a.keyCode==e.keyCode||(settings.autoShooterEnter.value&&13==e.keyCode||settings.autoShooterSpace.value&&32==e.keyCode)&&settings.autoShooterEnabled.value&&(a=e,n(),$j("#fight_btn").notify("AutoShooter started",{position:"top center",className:"info"}))},document.addEventListener("mouseup",function(){clearInterval(t)}),document.onkeyup=function(e){(settings.autoShooterEnter.value&&13==e.keyCode||settings.autoShooterSpace.value&&32==e.keyCode)&&(a=null,clearInterval(t))};var n=function(){if(settings.autoShooterEnabled.value){var a=function(){$j.post("/"+erepublik.settings.culture+"/military/fight-shoo"+(SERVER_DATA.onAirforceBattlefield?"oo":"o")+"t/"+SERVER_DATA.battleId,{sideId:SERVER_DATA.countryId,battleId:SERVER_DATA.battleId,_token:SERVER_DATA.csrfToken},function(a){if(settings.enableLogging.value&&console.log("[BATTLEEYE] Request sent. Received: "+a.message),"ENEMY_KILLED"==a.message){if(window.totalPrestigePoints+=a.hits,globalNS.updateSideBar(a.details),$j("#rank_min").text(e(a.rank.points)+" Rank Points"),$j("#rank_status_gained").css("width",a.rank.percentage+"%"),$j("#prestige_value").text(e(window.totalPrestigePoints)),$j("#side_bar_currency_account_value").text(e(a.details.currency)),$j(".left_player .energy_progress").css("width",a.details.current_energy_ratio+"%"),$j(".right_player .energy_progress").css("width",a.enemy.energyRatio+"%"),$j(".weapon_no").text(a.user.weaponQuantity),$j("#eRS_options").length<=0){var n=parseInt($j("#total_damage strong").text().replace(/,/g,""));$j("#total_damage strong").text(e(n+a.user.givenDamage))}}else"ENEMY_ATTACKED"==a.message||"LOW_HEALTH"==a.message?($j("#fight_btn").notify("Low health. AutoShooter stopped",{position:"top center",className:"info"}),t&&clearInterval(t)):"ZONE_INACTIVE"==a.message?($j("#fight_btn").notify("Zone is inactive. AutoShooter stopped",{position:"top center",className:"info"}),t&&clearInterval(t)):"SHOOT_LOCKOUT"==a.message?($j("#fight_btn").notify("Shoot lockout (Shooting too fast?). AutoShooter stopped.",{position:"top center",className:"info"}),t&&clearInterval(t)):($j("#fight_btn").notify('AutoShooter stopped. Received: "'+a.message+'"',{position:"top center",className:"warn"}),t&&clearInterval(t))})};settings.autoShooterStart.value&&a(),t=setInterval(a,Number(settings.autoShooterDelay.value)),settings.enableLogging.value&&console.log("[BATTLEEYE] AutoShooter started")}}}}]),t}(Module),ModuleLoader=function(){function e(t){_classCallCheck(this,e),this.modules={},this.storage=t}return _createClass(e,[{key:"load",value:function(e){if(e instanceof Module){this.modules[e.name]=e;var t=e.defineSettings();for(var a in t){var n=t[a];this.storage.define(n[0],n[1],e.name,n[2],n[3])}}}},{key:"get",value:function(e){return this.modules[e]}},{key:"run",value:function(){for(var e in this.modules)try{this.modules[e].run()}catch(t){console.error("Failed to run module "+e+"!: "+t)}}}]),e}(),Other=function(e){function t(){return _classCallCheck(this,t),_possibleConstructorReturn(this,Object.getPrototypeOf(t).call(this,"Other","Other miscellaneous enhancements"))}return _inherits(t,e),_createClass(t,[{key:"defineSettings",value:function(){return[["otherFixCometchat",!0,"Cometchat fix","Removes the fading, clickblocking line from the bottom of the screen. (Requires a page refresh)"]]}},{key:"run",value:function(){if(settings.otherFixCometchat.value)var e=function(){var e=document.getElementById("cometchat_base");if(null!==e){var a="width:auto;position:aboslute;right:0;background:none;";e.setAttribute("style",a),clearInterval(t)}},t=setInterval(e,500)}}]),t}(Module),Divisions=function(){function e(){_classCallCheck(this,e);this.divisions={}}return _createClass(e,[{key:"create",value:function(e,t){return this.divisions[e]=new DivisionStats(t),this.divisions[e]}},{key:"get",value:function(e){return this.divisions[e]}},{key:"handle",value:function(e){for(var t in this.divisions)this.divisions[t].handle(e)}},{key:"updateDps",value:function(e){for(var t in this.divisions)this.divisions[t].updateDps(e)}},{key:"toObject",value:function(){var e={};for(var t in this.divisions)e[t]=this.divisions[t].toObject();return e}}]),e}(),DivisionStats=function(e){function t(e){_classCallCheck(this,t);var a=_possibleConstructorReturn(this,Object.getPrototypeOf(t).call(this,10));return a.division=e,a.hits=0,a.damage=0,a}return _inherits(t,e),_createClass(t,[{key:"handle",value:function(e){e.division==this.division&&(this.addHit(e.msg.damage),this.hits++,this.damage+=e.msg.damage)}},{key:"toObject",value:function(){return{damage:this.damage,id:this.id,dps:this.dps,hits:this.hits,avgHit:0|Math.round(this.damage/this.hits)}}}]),t}(DpsHandler),EventHandler=function(){function e(){_classCallCheck(this,e),this.events={}}return _createClass(e,[{key:"emit",value:function(e,t){this.events[e]&&this.events[e].forEach(function(e){return e(t)})}},{key:"on",value:function(e,t){this.events[e]=this.events[e]||[],this.events[e].push(t)}},{key:"off",value:function(e,t){if(this.events[e])for(var a in this.events[e]){var n=this.events[e][a];n==t&&this.events[e].splice(a,1)}}}]),e}(),HitHistory=function(){function e(){var t=arguments.length<=0||void 0===arguments[0]?3e4:arguments[0];_classCallCheck(this,e),this.rememberFor=t,this.history={}}return _createClass(e,[{key:"add",value:function(e){var t=(new Date).getTime();this.history[t]=e,this.trimOld(t)}},{key:"trimOld",value:function(){var e=arguments.length<=0||void 0===arguments[0]?(new Date).getTime():arguments[0];for(var t in this.history)e-t-this.rememberFor>0&&delete this.history[t]}},{key:"clear",value:function(){this.history={}}},{key:"getTotal",value:function(){this.trimOld();var e=0;for(var t in this.history)e+=this.history[t];return e}}]),e}(),Layout=function(){function e(t,a){_classCallCheck(this,e);var n=this;n.headerData=a;var i=document.createElement("div");i.setAttribute("id","battle_eye_live"),settings.moveToTop.value?$j("#content").prepend(i):$j("#content").append(i),t.load()}return _createClass(e,[{key:"update",value:function(e){ReactDOM.render(React.createElement(Template,{settings:settings,feedData:e,headerData:this.headerData}),document.getElementById("battle_eye_live"))}}]),e}(),Stats=function(e){function t(e){_classCallCheck(this,t);var a=_possibleConstructorReturn(this,Object.getPrototypeOf(t).call(this,10));return a.id=e,a.damage=0,a.hits=0,a.constructDivisions(),a}return _inherits(t,e),_createClass(t,[{key:"constructDivisions",value:function(){this.divisions=new Divisions,this.divisions.create("div1",1),this.divisions.create("div2",2),this.divisions.create("div3",3),this.divisions.create("div4",4),this.divisions.create("div11",11)}},{key:"isSide",value:function(e){return this.id==e}},{key:"updateDps",value:function(e){_get(Object.getPrototypeOf(t.prototype),"updateDps",this).call(this,e),this.divisions.updateDps(e)}},{key:"handle",value:function(e){this.isSide(e.side)&&(this.divisions.handle(e),this.addHit(e.msg.damage),this.hits++,this.damage+=e.msg.damage)}},{key:"toObject",value:function(){return{damage:this.damage,id:this.id,dps:this.dps,hits:this.hits,avgHit:Math.round(this.damage/this.hits),divisions:this.divisions.toObject()}}}]),t}(DpsHandler),Storage=function(){function e(){_classCallCheck(this,e);var t=this;return t.checkIfStorageAvailable()?(t.prepend="battle_eye_",t.fields={},void(t.defaults={})):!1}return _createClass(e,[{key:"set",value:function(e,t){var a=this;localStorage.setItem(""+a.prepend+e,t),console.log("[BATTLEEYE] "+a.prepend+e+" = "+t)}},{key:"get",value:function(e){var t=this,a=localStorage.getItem(""+t.prepend+e);switch(a){case"true":a=!0;break;case"false":a=!1}return a}},{key:"has",value:function(e){var t=this;return!!localStorage.getItem(""+t.prepend+e)}},{key:"define",value:function(e,t,a,n,i){var s=this;s.defaults[e]={id:e,name:n,desc:i,group:a,value:t}}},{key:"loadSettings",value:function(){var e=this;for(var t in e.defaults){var a=e.defaults[t];void 0===e.fields[t]&&(e.fields[t]={id:a.id,name:a.name,desc:a.desc,group:a.group}),e.has(t)||e.set(t,a.value)}}},{key:"loadDefaults",value:function(){var e=this;for(var t in e.defaults)e.set(t,e.defaults[t].value)}},{key:"getAll",value:function(){var e=this,t={};for(var a in e.fields){var n=e.fields[a];t[a]={field:n,value:e.get(n.id)}}return t}},{key:"checkIfStorageAvailable",value:function(){return"undefined"!=typeof e}}]),e}(),Stylesheet=function(){function e(){_classCallCheck(this,e),this.sheet="",this.sheet+="\n            @keyframes bel-pulse {\n                0% {\n                    border-color: #27ae60;\n                }\n\n                10% {\n                    border-color: #2ecc71;\n                }\n\n                100% {\n                    border-color: #27ae60;\n                }\n            }\n\n            .bel-spinner {\n              width: 50px;\n              height: 20px;\n              text-align: center;\n              font-size: 10px;\n              padding-top: 8px;\n            }\n\n            .bel-spinner > div {\n              background-color: #2980b9;\n              height: 100%;\n              width: 6px;\n              display: inline-block;\n\n              -webkit-animation: sk-stretchdelay 1.2s infinite ease-in-out;\n              animation: sk-stretchdelay 1.2s infinite ease-in-out;\n            }\n\n            .bel-spinner .rect2 {\n              -webkit-animation-delay: -1.1s;\n              animation-delay: -1.1s;\n              background-color: #3498db;\n            }\n\n            .bel-spinner .rect3 {\n              -webkit-animation-delay: -1.0s;\n              animation-delay: -1.0s;\n              background-color: #2980b9;\n            }\n\n            .bel-spinner .rect4 {\n              -webkit-animation-delay: -0.9s;\n              animation-delay: -0.9s;\n              background-color: #3498db;\n            }\n\n            .bel-spinner .rect5 {\n              -webkit-animation-delay: -0.8s;\n              animation-delay: -0.8s;\n              background-color: #2980b9;\n            }\n\n            @-webkit-keyframes sk-stretchdelay {\n              0%, 40%, 100% { -webkit-transform: scaleY(0.4) }\n              20% { -webkit-transform: scaleY(1.0) }\n            }\n\n            @keyframes sk-stretchdelay {\n              0%, 40%, 100% {\n                transform: scaleY(0.4);\n                -webkit-transform: scaleY(0.4);\n              }  20% {\n                transform: scaleY(1.0);\n                -webkit-transform: scaleY(1.0);\n              }\n            }\n        ",this.addCSSRule(".clearfix:after",'\n            content: "";\n            display: table;\n            clear: both;\n        '),this.addCSSRule(".bel-tabs","\n            margin: 5px 0;\n        "),this.addCSSRule(".bel-tabs button","\n            border-radius: 0px;\n        "),this.addCSSRule(".bel-tabs button:first-child","\n            border-radius: 4px 0 0 4px;\n        "),this.addCSSRule(".bel-tabs button:last-child","\n            border-radius: 0 4px 4px 0;\n        "),this.addCSSRule(".bel-country","\n            width: 28px;\n            height: 25px;\n            margin-bottom: -5px;\n            margin-left: 5px;\n            margin-right: 5px;\n            display: inline-block;\n        "),this.addCSSRule("#battle_eye_live",'\n            width: 100%;\n            position:relative;\n            float:left;\n            padding:10px;\n            box-sizing: border-box;\n            border-radius:0px 0px 20px 20px;\n            background-color: #ffffff;\n            color: #34495e;\n            font-size:14px;\n            font-family: "Lato",Helvetica,Arial,sans-serif;\n            text-align: center;\n            line-height: 1.7;\n        '),this.addCSSRule(".color-silver","color: #bdc3c7"),this.addCSSRule(".pull-left","float:left;"),this.addCSSRule(".pull-right","float:right;"),this.addCSSRule("#battle_eye_live *,#battle_eye_live *:after,#battle_eye_live *:before","-webkit-box-sizing: border-box;-moz-box-sizing: border-box;box-sizing: border-box;"),this.addCSSRule(".bel-value","\n            display: inline-block;\n            line-height: 1.2;\n            background-color: #ecf0f1;\n            padding: 2px 10px;\n            border-radius: 4px;\n            margin: 0 2px 2px 2px;\n        "),
this.addCSSRule(".bel-value-hl","\n            animation: bel-pulse 5s infinite;\n            border: 1px solid #27ae60;\n        "),this.addCSSRule(".text-center","text-align:center;"),this.addCSSRule(".text-left","text-align:left;"),this.addCSSRule(".text-right","text-align:right;"),this.addCSSRule(".bel-version","background-color: #34495e;color:#ecf0f1;padding: 3px 8px;border-radius:4px;margin-right:4px;"),this.addCSSRule(".bel-version-outdated","background-color: #e74c3c;"),this.addCSSRule(".bel-title","background-color: #ecf0f1;margin-bottom:2px;margin-top:5px;"),this.addCSSRule(".bel-titles","\n            font-weight: 700;\n        "),this.addCSSRule(".bel-text-tiny","font-size:10px;"),this.addCSSRule(".bel-highlight-title","\n            background-color: #34495e;\n            color: #fff;\n        "),this.addCSSRule(".bel-highlight","\n            color: #34495e;\n        "),this.addCSSRule(".bel-grid:after",'content: "";display: table;clear: both;'),this.addCSSRule("[class*='bel-col-']","float: left;"),this.addCSSRule(".bel-col-1-1","width: 100%;"),this.addCSSRule(".bel-col-1-2","width: 50%;"),this.addCSSRule(".bel-col-1-4","width: 25%;"),this.addCSSRule(".bel-col-1-3","width: 33.3333%;"),this.addCSSRule(".bel-col-1-8","width: 12.5%;"),this.addCSSRule(".list-unstyled","list-style: outside none none;padding-left: 0;"),this.addCSSRule(".list-inline li","display: inline-block;"),this.addCSSRule(".bel-settings","\n            z-index: 100;\n            position: absolute;\n            width: 100%;\n            opacity: 0.95;\n            top: 0;\n            left: 0;\n            background-color: #ffffff;\n            padding: 14px;\n            text-align: left;\n            overflow-y: scroll;\n            height: 100%;\n        "),this.addCSSRule(".bel-settings-group","\n            background-color: #34495e;\n            color: #ecf0f1;\n            padding-left: 10px;\n        "),this.addCSSRule(".bel-settings-container","\n            padding-left: 5px;\n        "),this.addCSSRule(".bel-settings-field","\n            margin-right: 3px;\n        "),this.addCSSRule(".bel-field-description","\n            font-size: 12px;\n            color: #95a5a6;\n        "),this.addCSSRule(".bel-checkbox","\n            padding: 5px 3px;\n            border-bottom: 1px solid #ecf0f1;\n        "),this.addCSSRule(".bel-hidden","\n            display: none;\n        "),this.addCSSRule(".bel-btn",'\n            -webkit-user-select: none;\n            -moz-user-select: none;\n            -ms-user-select: none;\n            user-select: none;\n            background-image: none;\n            border: none !important;\n            cursor: pointer;\n            font-size: 13px;\n            font-weight: normal;\n            margin-bottom: 0;\n            text-align: center;\n            border-radius: 4px;\n            padding: 3px 8px;\n            font-family: "Lato",Helvetica,Arial,sans-serif;\n            transition: background-color 0.5s;\n        '),this.addCSSRule("a.bel-btn","\n            padding: 4px 8px;\n        "),this.addCSSRule(".bel-btn-default","\n            background-color: #1abc9c;\n            color: #ffffff;\n        "),this.addCSSRule(".bel-btn-default:hover","\n            background-color: #16a085;\n        "),this.addCSSRule(".bel-btn-grey","\n            background-color: #ecf0f1;\n            color: #34495e;\n        "),this.addCSSRule(".bel-btn-grey:hover","\n            background-color: #CED3D6;\n        "),this.addCSSRule(".bel-btn-danger","\n            background-color: #e74c3c;\n            color: #ffffff;\n        "),this.addCSSRule(".bel-btn-danger:hover","\n            background-color: #c0392b;\n        "),this.addCSSRule(".bel-btn-inverse","\n            background-color: #2c3e50;\n            color: #ffffff;\n        "),this.addCSSRule(".bel-btn-inverse:hover","\n            background-color: #34495e;\n        "),this.addCSSRule(".bel-btn-info","\n            background-color: #2980b9;\n            color: #ffffff;\n        "),this.addCSSRule(".bel-btn-info:hover","\n            background-color: #3498db;\n        "),this.addCSSRule(".bel-header-menu","margin-bottom: 10px;"),this.addCSSRule(".bel-header-menu li","padding: 0 5px;"),this.addCSSRule(".bel-teama","background-color: #27ae60;"),this.addCSSRule(".bel-teamb","background-color: #c0392b;"),this.addCSSRule(".bel-teama-color","color: #27ae60;"),this.addCSSRule(".bel-teamb-color","color: #c0392b;"),this.addCSSRule(".bel-progress","\n            height: 4px;\n            position: relative;\n            background: #ebedef none repeat scroll 0 0;\n            border-radius: 32px;\n            box-shadow: none;\n            margin-top: 2px;\n            overflow: hidden;\n        "),this.addCSSRule(".bel-progress-bar","\n            box-shadow: none;\n            line-height: 12px;\n            color: #fff;\n            float: left;\n            font-size: 12px;\n            height: 100%;\n            line-height: 20px;\n            text-align: center;\n            transition: width 0.6s ease 0s;\n            width: 0;\n        "),this.addCSSRule(".bel-progress-center-marker","\n            border-right: 3px solid #ffffff;\n            height: 10px;\n            left: 50%;\n            margin-left: -2px;\n            opacity: 0.6;\n            position: absolute;\n        "),this.addCSSRule(".bel-hr","\n            -moz-border-bottom-colors: none;\n            -moz-border-left-colors: none;\n            -moz-border-right-colors: none;\n            -moz-border-top-colors: none;\n            border-color: #eee -moz-use-text-color -moz-use-text-color;\n            border-image: none;\n            border-style: solid none none;\n            border-width: 1px 0 0;\n            margin-bottom: 20px;\n        ")}return _createClass(e,[{key:"addCSSRule",value:function(e,t){this.sheet+=e+"{"+t+"}"}},{key:"load",value:function(){$j("head").append("<style>"+this.sheet+"</style>")}}]),e}(),Utils=function(){function e(){_classCallCheck(this,e)}return _createClass(e,[{key:"uid",value:function(){return("0000"+(Math.random()*Math.pow(36,4)<<0).toString(36)).slice(-4)}}]),e}(),UTILS=new Utils,settings={},contributors=[],modules=null,storage=null,battleEyeLive={init:function(){var e=this;return console.log("[BATTLEEYE] Initialisation"),storage=e.settingsStorage=new Storage,storage===!1?console.error("LocalStorage is not available! Battle Eye initialisation canceled"):(storage.define("showOtherDivs",!0,"Structure","Show other divisions","You can select what divisions you want to see with the settings below."),storage.define("showDiv1",!0,"Structure","Show DIV 1"),storage.define("showDiv2",!0,"Structure","Show DIV 2"),storage.define("showDiv3",!0,"Structure","Show DIV 3"),storage.define("showDiv4",!0,"Structure","Show DIV 4"),storage.define("showAverageDamage",!1,"Structure","Show average damage dealt"),storage.define("showKills",!1,"Structure","Show kills done by each division"),storage.define("showDamagePerc",!0,"Structure","Show Damage percentages"),storage.define("moveToTop",!1,"Structure","Display BattleEye above the battlefield","*Requires a page refresh"),storage.define("reduceLoad",!1,"Performance","Render every second","Stats will be refreshed every second instead of after every kill. This can improve performance"),storage.define("gatherBattleStats",!0,"Performance","Gather battle stats","Displays total damage and kills since the beginning of the round. Disabling this will reduce the load time."),storage.define("highlightDivision",!0,"Visual","Highlight current division"),storage.define("highlightValue",!0,"Visual","Highlight winning side"),storage.define("showDpsBar",!0,"Bars","Show DPS bar"),storage.define("showDamageBar",!0,"Bars","Show Damage bar"),storage.define("largerBars",!1,"Bars","Larger bars"),storage.define("enableLogging",!1,"Other","Enable logging to console"),modules=new ModuleLoader(e.settingsStorage),modules.load(new AutoShooter),modules.load(new Other),storage.loadSettings(),settings=storage.getAll(),e.events=new EventHandler,e.teamA=new Stats(SERVER_DATA.leftBattleId),e.teamAName=SERVER_DATA.countries[SERVER_DATA.leftBattleId],e.teamB=new Stats(SERVER_DATA.rightBattleId),e.teamBName=SERVER_DATA.countries[SERVER_DATA.rightBattleId],settings.gatherBattleStats.value&&e.getBattleStats(function(t,a,n,i){var s=[1,2,3,4,11];for(var l in s){var r=s[l],o=0,c=0,d=0,u=0;for(var h in t["div"+r]){var g=t["div"+r][h];o+=Number(g.value.replace(/[,\.]/g,""))}for(var h in a["div"+r]){var g=a["div"+r][h];c+=Number(g.value.replace(/[,\.]/g,""))}for(var h in n["div"+r]){var g=n["div"+r][h];d+=Number(g.value.replace(/[,\.]/g,""))}for(var h in i["div"+r]){var g=i["div"+r][h];u+=Number(g.value.replace(/[,\.]/g,""))}e.teamA.divisions.get("div"+r).damage+=o,e.teamB.divisions.get("div"+r).damage+=c,e.teamA.damage+=o,e.teamB.damage+=c,e.teamA.divisions.get("div"+r).hits+=d,e.teamB.divisions.get("div"+r).hits+=u,e.teamA.hits+=d,e.teamB.hits+=u}$j("#bel-loading").hide()}),e.layout=new Layout(new Stylesheet,{teamAName:this.teamAName,teamBName:this.teamBName,version:GM_info.script.version}),e.layout.update(e.getTeamStats()),pomelo.disconnect=function(){},e.checkForUpdates(),$j(".bel-settings-field").on("change",function(t){var a=t.target;if("checkbox"==a.type)var n=a.checked;else var n=a.value;e.settingsStorage.set(a.name,n),settings[a.name].value=n;var i=$j(this).attr("id");$j('label[for="'+i+'"]').notify("Saved",{position:"right middle",className:"success"})}),e.runTicker(),e.handleEvents(),void modules.run())},resetSettings:function(){storage.loadDefaults(),settings=storage.getAll()},checkForUpdates:function(){var e=this;$j.get("https://googledrive.com/host/0B3BZg10JinisM29sa05qV0NyMmM/data.json",function(t){contributors=t.contributors,e.displayContributors();var a=parseInt(t.version.replace(/\D/g,"")),n=parseInt(GM_info.script.version.replace(/\D/g,""));n!=a&&(document.querySelector(".bel-version").classList.add("bel-version-outdated"),document.querySelector("#bel-version").innerHTML+='<a class="bel-btn" href="https://googledrive.com/host/0B3BZg10JinisM29sa05qV0NyMmM/battle-eye-live.user.js">Update</a>')})},displayContributors:function(){for(var e in contributors){var t=contributors[e];for(var a in t){var n=t[a];erepublik.citizen.citizenId==n?$j("#battleConsole .left_player .player_name").css({textShadow:" 0 0 10px "+e,color:e}).attr("original-title","BattleEye contributor").tipsy():$j('li[data-citizen-id="'+n+'"] .player_name').length>0&&$j('li[data-citizen-id="'+n+'"] .player_name').css({textShadow:" 0 0 10px "+e,color:e}).attr("original-title","BattleEye contributor").tipsy()}}},getTeamStats:function(){return{left:this.teamA.toObject(),right:this.teamB.toObject()}},getBattleStats:function(e){var t=this,a=SERVER_DATA.leftBattleId,n=SERVER_DATA.rightBattleId,i={div1:[],div2:[],div3:[],div4:[],div11:[]},s={div1:[],div2:[],div3:[],div4:[],div11:[]},l={div1:[],div2:[],div3:[],div4:[],div11:[]},r={div1:[],div2:[],div3:[],div4:[],div11:[]},o=function(e,t,a,n,i){void 0==i&&(i="damage"),$j.post("https://www.erepublik.com/en/military/battle-console",{_token:SERVER_DATA.csrfToken,action:"battleStatistics",battleId:SERVER_DATA.battleId,division:e,leftPage:t,rightPage:a,round:SERVER_DATA.zoneId,type:i,zoneId:1},function(i){settings.enableLogging.value&&console.log("[BATTLEEYE] Gathered div"+e+" stats; page "+t+"|"+a),n(i)})},c=function(e,t){var l=1,r=1;async.doWhilst(function(t){o(e,l,l,function(o){for(var c in o[a].fighterData)i["div"+e].push(o[a].fighterData[c]);for(var c in o[n].fighterData)s["div"+e].push(o[n].fighterData[c]);r=Math.max(o[a].pages,o[n].pages),l++,t()},"damage")},function(){return r>l},function(){t()})},d=function(e,t){var i=1,s=1;async.doWhilst(function(t){o(e,i,i,function(o){for(var c in o[a].fighterData)l["div"+e].push(o[a].fighterData[c]);for(var c in o[n].fighterData)r["div"+e].push(o[n].fighterData[c]);s=Math.max(o[a].pages,o[n].pages),i++,t()},"kills")},function(){return s>i},function(){t()})},u=11==SERVER_DATA.division?[11]:[1,2,3,4];async.each(u,c.bind(t),function(){async.each(u,d.bind(t),function(){e(i,s,l,r)})})},runTicker:function(){var e=this,t=0,a=function(){t++;var a={second:t,time:(new Date).getTime()};e.events.emit("tick",a)};e.interval=setInterval(a,1e3)},handleEvents:function(){var e=this;e.events.on("tick",function(t){e.teamA.updateDps(t),e.teamB.updateDps(t),e.layout.update(e.getTeamStats())})},overridePomelo:function(){var e=this,t=function(t){"Maximum"!==currentPlayerDisplayRateValue?battleFX.checkPlayerDisplayRate(currentPlayerDisplayRateValue)&&battleFX.populatePlayerData(t):battleFX.populatePlayerData(t),e.displayContributors(),e.handle(t)};pomelo.on("onMessage",t)},handle:function(e){var t=this;t.teamA.handle(e),t.teamB.handle(e),settings.reduceLoad.value||t.layout.update(t.getTeamStats())}};battleEyeLive.init(),setTimeout(function(){battleEyeLive.overridePomelo()},2e3);